services:
  mlflow:
    container_name: mlflow_server
    build: 
      # Giữ nguyên cấu hình build (Nếu bạn dùng Compose để Build Image)
      context: .
      dockerfile: Dockerfile
    
    # SỬA LỆNH: Trỏ backend-store và artifact-root sang PostgreSQL và MinIO
    command:
      - bash
      - -c
      - "mlflow server \
        --backend-store-uri postgresql://postgres:aivn2025@postgres-service.nexusml.svc.cluster.local:5432/image_db \
        --default-artifact-root s3://mlflow-artifact-storage/ \
        --host 0.0.0.0 \
        --port 5000"
        
    ports:
      - "5000:5000"
      
    # THÊM BIẾN MÔI TRƯỜNG CHO KẾT NỐI MINIO/S3
    environment:
      # Biến môi trường cho S3 (MinIO) Endpoint
      MLFLOW_S3_ENDPOINT_URL: "http://minio-service.nexusml.svc.cluster.local:9000" 
      # Credentials cho MinIO (sử dụng thông tin bạn đã thiết lập trong Secret)
      AWS_ACCESS_KEY_ID: "minio-access-key" # Thay bằng Key thực tế của bạn
      AWS_SECRET_ACCESS_KEY: "minio-secret-key" # Thay bằng Secret thực tế của bạn

    # Không cần thiết phải mount volume nếu chỉ dùng làm ví dụ Compose, 
    # nhưng nếu mount, cần chú ý đường dẫn data
    volumes:
      - ./run_env/data:/mlflow